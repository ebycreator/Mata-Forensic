<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Meta Forensic</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ExifReader -->
  <script src="https://cdn.jsdelivr.net/npm/exifreader/dist/exif-reader.min.js"></script>

  <!-- Leaflet Maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      background: #0f0f0f url('https://images.unsplash.com/photo-1616401785984-ded538da8c10?auto=format&fit=crop&w=1920&q=80') 
        no-repeat center center fixed;
      background-size: cover;
    }
    .metadata-card {
      background:white;
      border:1px solid #ccc;
      padding:8px 12px;
      border-radius:6px;
      margin-bottom:6px;
      display:flex;
      justify-content:space-between;
      font-size:14px;
    }
    .metadata-key { font-weight:600; color:#1e40af; }
    .metadata-value { color:#111; text-align:right; }
    #map { height:200px; border-radius:8px; margin-top:6px; }
  </style>
</head>

<body class="text-white min-h-screen p-6">
  <div class="max-w-6xl mx-auto">

    <header class="text-center mb-6">
      <h1 class="text-4xl font-bold text-white drop-shadow">Meta Forensic</h1>
      <p class="opacity-80">Upload an image to extract forensic metadata</p>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      
      <!-- Upload Section -->
      <section>
        <div id="drop" class="border-2 border-dashed border-gray-300 bg-white/70 text-black p-6 rounded shadow">
          <input id="fileInput" type="file" accept="image/*" class="hidden">
          <p class="mb-2">Drag & Drop an image here</p>
          <button id="chooseBtn" class="px-4 py-2 rounded bg-indigo-600 text-white">Choose Image</button>
        </div>

        <div id="previewWrap" class="hidden bg-white/90 p-4 mt-4 rounded shadow text-black">
          <img id="preview" class="w-40 h-40 object-contain border rounded mb-3">
          <p id="basicInfo" class="text-sm"></p>
        </div>
      </section>

      <!-- Metadata Section -->
      <aside>
        <div id="gpsWrap" class="hidden bg-white/90 p-4 rounded shadow text-black">
          <h3 class="font-bold text-indigo-700 mb-1">GPS Data</h3>
          <p id="gpsText" class="text-sm"></p>
          <a id="gpsLink" target="_blank" class="text-blue-600 underline text-sm">Open in Google Maps</a>
          <div id="map"></div>
        </div>

        <div id="metadataWrap" class="hidden bg-white/90 p-4 mt-4 rounded shadow text-black">
          <h3 class="font-bold text-indigo-700 mb-2">Metadata</h3>
          <div id="metadataList"></div>
        </div>
      </aside>

    </main>
  </div>

<script>
const drop = document.getElementById('drop');
const chooseBtn = document.getElementById('chooseBtn');
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const previewWrap = document.getElementById('previewWrap');

const gpsWrap = document.getElementById('gpsWrap');
const gpsText = document.getElementById('gpsText');
const gpsLink = document.getElementById('gpsLink');

const metadataWrap = document.getElementById('metadataWrap');
const metadataList = document.getElementById('metadataList');

let map = null;
let mapMarker = null;

chooseBtn.onclick = () => fileInput.click();
fileInput.onchange = (e) => handleFiles(e.target.files);

drop.addEventListener('dragover', evt => evt.preventDefault());
drop.addEventListener('drop', evt => {
  evt.preventDefault();
  const f = evt.dataTransfer.files[0];
  if (f) handleFiles([f]);
});

async function handleFiles(files){
  const file = files[0];
  const array = await file.arrayBuffer();
  const reader = new FileReader();

  reader.onload = () => {
    preview.src = reader.result;
    previewWrap.classList.remove("hidden");
  };
  reader.readAsDataURL(file);

  // Extract EXIF
  let tags = {};
  try { tags = await ExifReader.load(array); } catch(e){}

  const metadata = normalizeTags(tags);

  showMetadata(metadata);
  showGPS(metadata);

  document.getElementById("basicInfo").textContent =
    `Type: ${file.type} â€¢ Size: ${(file.size/1024).toFixed(1)} KB`;
}

function normalizeTags(tags){
  const out={};
  for(const k in tags){
    try{
      out[k] = tags[k].description || tags[k].value || tags[k];
    }catch(e){}
  }

  // GPS extraction
  if(tags.GPSLatitude && tags.GPSLongitude){
    const lat = convertToDecimal(tags.GPSLatitude.value);
    const lon = convertToDecimal(tags.GPSLongitude.value);
    out._latitude = lat;
    out._longitude = lon;
  }

  return out;
}

function convertToDecimal(v){
  if(!v) return null;
  return v[0] + v[1]/60 + v[2]/3600;
}

function showMetadata(data){
  metadataList.innerHTML = "";
  metadataWrap.classList.remove("hidden");

  Object.entries(data).forEach(([key,val])=>{
    const card = document.createElement("div");
    card.className = "metadata-card";

    card.innerHTML =
      `<div class='metadata-key'>${key}</div>
       <div class='metadata-value'>${val}</div>`;

    metadataList.appendChild(card);
  });
}

function showGPS(data){
  if(!data._latitude || !data._longitude){
    gpsWrap.classList.add("hidden");
    return;
  }

  gpsWrap.classList.remove("hidden");
  gpsText.textContent = `Lat: ${data._latitude}, Lon: ${data._longitude}`;
  gpsLink.href = `https://www.google.com/maps?q=${data._latitude},${data._longitude}`;

  if(!map){
    map = L.map('map').setView([data._latitude, data._longitude], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    mapMarker = L.marker([data._latitude, data._longitude]).addTo(map);
  } else {
    map.setView([data._latitude, data._longitude], 13);
    mapMarker.setLatLng([data._latitude, data._longitude]);
  }
}
</script>

</body>
</html>
