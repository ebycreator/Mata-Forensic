<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>META FORENSIC ‚Äî Dark Forensic UI</title>

  <!-- Tailwind (quick) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ExifReader -->
  <script src="https://cdn.jsdelivr.net/npm/exifreader@4.12.0/dist/exif-reader.min.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- CryptoJS for MD5 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- jsPDF + html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    :root {
      --bg: #071021;
      --panel: rgba(9,12,20,0.85);
      --card: rgba(255,255,255,0.03);
      --accent: #0ea5e9;
      --glass: rgba(255,255,255,0.04);
      --muted: #9aa6b2;
      --text: #e6eef5;
    }
    body {
      background: linear-gradient(135deg, #020617 0%, #071021 60%);
      color: var(--text);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      min-height:100vh;
      margin:0;
      padding:18px;
    }
    .app {
      display:grid;
      grid-template-columns: 240px 1fr;
      gap:20px;
      max-width:1200px;
      margin:0 auto;
    }
    .sidebar {
      background: var(--panel);
      border-radius:12px;
      padding:14px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.6);
      height:calc(100vh - 36px);
      overflow:auto;
    }
    .main {
      min-height: calc(100vh - 36px);
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:10px;
      padding:12px;
      margin-bottom:12px;
      box-shadow: 0 6px 20px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.03);
    }
    .card-header {
      padding:8px 12px;
      border-radius:8px;
      background: linear-gradient(90deg, rgba(14,165,233,0.06), rgba(14,165,233,0.03));
      margin-bottom:10px;
      font-weight:700;
      color:var(--accent);
    }
    .menu-item { display:flex; gap:10px; align-items:center; padding:8px; border-radius:8px; cursor:pointer; color:var(--text); }
    .menu-item.active { background: rgba(14,165,233,0.08); box-shadow: inset 0 0 0 1px rgba(14,165,233,0.03); }

    .dropzone {
      border:2px dashed rgba(255,255,255,0.06);
      padding:18px;
      border-radius:10px;
      text-align:center;
      cursor:pointer;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
    }
    .dropzone.dragover { background: rgba(14,165,233,0.03); }

    .metadata-card {
      display:flex; justify-content:space-between; gap:8px;
      padding:10px; border-radius:8px; background: rgba(255,255,255,0.02); margin-bottom:8px;
      border:1px solid rgba(255,255,255,0.02);
    }
    .metadata-key { color: var(--accent); font-weight:700; }
    .metadata-value { color:var(--muted); text-align:right; word-break:break-word; max-width:65%; }

    #map { height:200px; border-radius:8px; overflow:hidden; }

    .btn { padding:8px 12px; border-radius:8px; font-weight:700; cursor:pointer; border:none; }
    .btn-primary { background:var(--accent); color:#001021; }
    .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--text); }

    .small { font-size:0.86rem; color:var(--muted); }
    .muted { color:var(--muted); }
    @media (max-width:980px) { .app { grid-template-columns: 1fr; } .sidebar { height:auto; } }
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <h1 class="text-2xl font-bold mb-2" style="color:var(--text)">META <span style="color:var(--accent)">FORENSIC</span></h1>
      <div id="menuMetadata" class="menu-item active" data-panel="metadata">üì∑ <span> Metadata</span></div>
      <div id="menuCases" class="menu-item" data-panel="cases">üóÇÔ∏è <span> Cases</span></div>
      <div id="menuCoc" class="menu-item" data-panel="coc">üîÅ <span> Chain-of-Custody</span></div>
      <div id="menuManip" class="menu-item" data-panel="manip">üß™ <span> Manipulation</span></div>

      <hr class="my-3" style="border-color: rgba(255,255,255,0.03)">

      <div class="card small">
        <div class="card-header">Tips</div>
        <ul>
          <li>Use JPEG for full EXIF</li>
          <li>Create a case first to auto-log imports</li>
          <li>Export PDF/JSON for evidence chain</li>
        </ul>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- METADATA PANEL -->
      <section id="panel-metadata" class="card">
        <div class="card-header">üìÅ Metadata Viewer</div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <div id="drop" class="dropzone">
              <input id="fileInput" type="file" accept="image/*" class="hidden" />
              <div id="dropInner">
                <p class="small">Drag & drop an image here or click</p>
                <button id="chooseBtn" class="btn btn-primary mt-2">Choose Image</button>
                <p class="small mt-2">JPEG (EXIF), PNG (limited), HEIC (browser-dependent)</p>
              </div>
            </div>

            <div id="previewWrap" class="card mt-3 hidden">
              <div class="flex gap-4">
                <img id="preview" class="w-40 h-40 object-contain rounded border" alt="preview">
                <div class="flex-1">
                  <div class="card-header">Preview & Info</div>
                  <div id="basicInfo" class="small">‚Äî</div>
                  <div class="mt-3 flex gap-2">
                    <button id="downloadMetaBtn" class="btn btn-ghost">Download JSON</button>
                    <button id="copyMetaBtn" class="btn btn-ghost">Copy</button>
                    <button id="downloadExcelBtn" class="btn btn-primary">Excel</button>
                    <button id="generatePdfBtn" class="btn btn-primary">PDF</button>
                  </div>
                </div>
              </div>
              <div class="mt-3">
                <canvas id="elaCanvas" style="width:100%; border-radius:6px;"></canvas>
                <div id="elaScore" class="small mt-2">ELA: ‚Äî</div>
              </div>
            </div>

          </div>

          <div>
            <div id="gpsWrap" class="card hidden">
              <div class="card-header">üåç GPS & Map</div>
              <div id="gpsText" class="small">‚Äî</div>
              <a id="gpsLink" class="small muted" target="_blank" rel="noopener">Open in Maps</a>
              <div id="map" class="mt-3"></div>
            </div>

            <div id="rawJsonWrap" class="card mt-4 hidden">
              <div class="card-header">üóÇÔ∏è Metadata</div>
              <div id="metadataCards" class="mt-2"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- CASES -->
      <section id="panel-cases" class="card hidden">
        <div class="card-header">üóÑÔ∏è Case Management</div>
        <div class="grid gap-3">
          <input id="caseTitle" class="p-2 rounded bg-transparent border border-white/5" placeholder="Case title">
          <input id="caseInvestigator" class="p-2 rounded bg-transparent border border-white/5" placeholder="Investigator">
          <div class="flex gap-2">
            <button id="createCaseBtn" class="btn btn-primary">Create Case</button>
            <button id="clearCasesBtn" class="btn btn-ghost">Clear Cases</button>
          </div>

          <label class="small muted">Select Case</label>
          <select id="caseSelect" class="p-2 rounded bg-transparent border border-white/5"></select>

          <div id="caseDetails" class="small muted">No case selected</div>
        </div>
      </section>

      <!-- COC -->
      <section id="panel-coc" class="card hidden">
        <div class="card-header">üîí Chain-of-Custody</div>
        <div class="grid gap-3">
          <input id="cocActor" class="p-2 rounded bg-transparent border border-white/5" placeholder="Actor (auto-filled)">
          <select id="cocAction" class="p-2 rounded bg-transparent border border-white/5">
            <option>Collected</option><option>Received</option><option>Transferred</option><option>Analyzed</option><option>Stored</option><option>Returned</option><option>Other</option>
          </select>
          <input id="cocNote" class="p-2 rounded bg-transparent border border-white/5" placeholder="Note">
          <div class="flex gap-2">
            <button id="addCocBtn" class="btn btn-primary">Add Entry</button>
            <button id="autoFillImportBtn" class="btn btn-ghost">Auto-fill Import (ON)</button>
          </div>

          <div id="cocLog" class="p-2 rounded bg-black/30 max-h-52 overflow-auto"></div>
          <div class="flex gap-2 mt-2">
            <button id="exportCocBtn" class="btn btn-primary">Export CoC</button>
            <button id="clearCocBtn" class="btn btn-ghost">Clear CoC</button>
          </div>
        </div>
      </section>

      <!-- MANIPULATION -->
      <section id="panel-manip" class="card hidden">
        <div class="card-header">üßæ Manipulation Report</div>
        <div class="grid gap-3">
          <div class="p-3 rounded bg-black/20">
            <div class="small"><strong>MD5:</strong> <span id="md5Val">-</span></div>
            <div class="small"><strong>SHA-1:</strong> <span id="sha1Val">-</span></div>
            <div class="small"><strong>SHA-256:</strong> <span id="sha256Val">-</span></div>
          </div>
          <div class="p-3 rounded bg-black/20">
            <div class="small"><strong>Detected Apps</strong></div>
            <div id="editApps" class="small muted">‚Äî</div>
          </div>
          <div class="p-3 rounded bg-black/20">
            <div class="small"><strong>Heuristic Notes</strong></div>
            <div id="manipNotes" class="small muted">‚Äî</div>
          </div>

          <div class="flex gap-2">
            <button id="downloadAllJsonBtn" class="btn btn-primary">Download Full JSON</button>
            <button id="downloadReportPdfBtn" class="btn btn-primary">Download PDF Report</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Hidden metadata text block used for export -->
  <pre id="metadata" style="display:none"></pre>

<script>
/* ================= App state ================= */
const CASES_KEY = 'mf_cases_v5';
let cases = loadCases();
let selectedCaseId = null;
let currentFile = null;
let currentMetadata = null;
let gpsMap = null;
let gpsMarker = null;
let lastHashes = { md5:null, sha1:null, sha256:null };
let autoFillImport = true;

/* ================ Menu handling ================ */
document.querySelectorAll('.menu-item').forEach(mi => mi.addEventListener('click', () => {
  document.querySelectorAll('.menu-item').forEach(x => x.classList.remove('active'));
  mi.classList.add('active');
  const panel = mi.dataset.panel;
  document.querySelectorAll('main section').forEach(sec => {
    sec.id === 'panel-' + panel ? sec.classList.remove('hidden') : sec.classList.add('hidden');
  });
}));

/* ================ Storage helpers ================ */
function loadCases(){ try { return JSON.parse(localStorage.getItem(CASES_KEY) || '[]'); } catch(e){ return []; } }
function saveCases(){ localStorage.setItem(CASES_KEY, JSON.stringify(cases)); }

/* ================ Case management ================ */
const caseSelect = document.getElementById('caseSelect');
const caseDetails = document.getElementById('caseDetails');

function refreshCaseList(){
  caseSelect.innerHTML = '<option value="">-- select case --</option>';
  for(const c of cases){
    const o = document.createElement('option'); o.value = c.id; o.textContent = `${c.id} ‚Äî ${c.title}`;
    caseSelect.appendChild(o);
  }
  renderCaseDetails();
}
function renderCaseDetails(){
  if(!selectedCaseId){ caseDetails.innerHTML = '<div class="small muted">No case selected</div>'; document.getElementById('cocLog').innerHTML='(no CoC)'; document.getElementById('cocActor').value=''; return; }
  const c = cases.find(x=>x.id===selectedCaseId);
  if(!c) return;
  caseDetails.innerHTML = `<div class="small muted"><strong>Case</strong>: ${c.id} ‚Äî ${c.title}<br><strong>Investigator</strong>: ${c.investigator || '(not set)'}</div>`;
  const cocEl = document.getElementById('cocLog'); cocEl.innerHTML = '';
  if(!c.coc || c.coc.length===0) cocEl.textContent = '(no custody entries)';
  else {
    for(const e of c.coc){
      const d = document.createElement('div'); d.className = 'border-b py-1 small';
      d.innerHTML = `<strong>${new Date(e.time).toLocaleString()}</strong><div>${e.actor} ‚Äî ${e.action}${e.note ? ' ‚Äî ' + e.note : ''}</div>`;
      cocEl.appendChild(d);
    }
  }
  document.getElementById('cocActor').value = c.investigator || '';
}

/* Case events */
document.getElementById('createCaseBtn').addEventListener('click', () => {
  const title = document.getElementById('caseTitle').value.trim();
  const investigator = document.getElementById('caseInvestigator').value.trim();
  if(!title) return alert('Enter a case title');
  const id = 'CASE-' + Date.now().toString().slice(-8);
  cases.push({ id, title, investigator, coc: [] });
  saveCases(); selectedCaseId = id; refreshCaseList(); caseSelect.value = id; renderCaseDetails();
  document.getElementById('caseTitle').value=''; document.getElementById('caseInvestigator').value='';
});
document.getElementById('clearCasesBtn').addEventListener('click', () => {
  if(!confirm('Clear all cases and CoC?')) return;
  cases=[]; saveCases(); selectedCaseId=null; refreshCaseList();
});
caseSelect.addEventListener('change', ()=> { selectedCaseId = caseSelect.value || null; renderCaseDetails(); });

/* ================ Chain-of-Custody ================ */
function addCocEntry(actor, action, note){
  if(!selectedCaseId) return alert('Select a case first.');
  const c = cases.find(x=>x.id===selectedCaseId);
  if(!c) return;
  const entry = { actor: actor || c.investigator || 'Unknown', action, note: note||'', time: new Date().toISOString() };
  c.coc = c.coc || []; c.coc.push(entry); saveCases(); renderCaseDetails();
}
document.getElementById('addCocBtn').addEventListener('click', () => {
  addCocEntry(document.getElementById('cocActor').value.trim(), document.getElementById('cocAction').value, document.getElementById('cocNote').value.trim());
  document.getElementById('cocNote').value='';
});
document.getElementById('exportCocBtn').addEventListener('click', () => {
  if(!selectedCaseId) return alert('Select a case');
  const c = cases.find(x=>x.id===selectedCaseId);
  const blob = new Blob([JSON.stringify(c, null, 2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `CoC_${c.id}.json`; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('clearCocBtn').addEventListener('click', () => {
  if(!selectedCaseId) return alert('Select a case');
  if(!confirm('Clear CoC for this case?')) return;
  const c = cases.find(x=>x.id===selectedCaseId); c.coc = []; saveCases(); renderCaseDetails();
});
document.getElementById('autoFillImportBtn').addEventListener('click', function(){
  autoFillImport = !autoFillImport; this.textContent = autoFillImport ? 'Auto-fill Import (ON)' : 'Auto-fill Import (OFF)';
  this.classList.toggle('btn-primary');
});

/* ================ File handling, EXIF, map ================ */
const drop = document.getElementById('drop');
const fileInput = document.getElementById('fileInput');
const chooseBtn = document.getElementById('chooseBtn');
const previewWrap = document.getElementById('previewWrap');

chooseBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

['dragenter','dragover'].forEach(evt => {
  drop.addEventListener(evt, (ev) => { ev.preventDefault(); drop.classList.add('dragover'); });
});
['dragleave','drop'].forEach(evt => {
  drop.addEventListener(evt, (ev) => { ev.preventDefault(); drop.classList.remove('dragover'); });
});
drop.addEventListener('drop', ev => { const f = ev.dataTransfer.files && ev.dataTransfer.files[0]; if(f) handleFiles([f]); });

async function handleFiles(files){
  if(!files || files.length === 0) return;
  const file = files[0]; currentFile = file;
  const arrayBuffer = await file.arrayBuffer();
  const dataUrl = await readAsDataURL(file);
  document.getElementById('preview').src = dataUrl;
  previewWrap.classList.remove('hidden');

  // load exif
  let tags = {};
  try { tags = ExifReader.load(arrayBuffer, { expanded: true }); } catch(e){ console.warn('EXIF read failed', e); tags = {}; }
  currentMetadata = normalizeTags(tags);

  // compute hashes
  lastHashes.md5 = await computeMD5(arrayBuffer);
  lastHashes.sha1 = await computeSubtleHash(arrayBuffer, 'SHA-1');
  lastHashes.sha256 = await computeSubtleHash(arrayBuffer, 'SHA-256');

  // run ELA (async) and UI updates
  const elaScore = await runELA(document.getElementById('preview')).catch(()=>0);
  document.getElementById('elaScore').textContent = `ELA mean diff: ${elaScore.toFixed(2)}`;

  updateBasicInfo(file);
  renderFields(currentMetadata);
  renderMetadataCards(currentMetadata);
  renderManipulationInfo(tags, lastHashes);

  if(autoFillImport && selectedCaseId){
    const note = `Imported ${file.name} (${(file.size/1024).toFixed(1)} KB) SHA-256: ${lastHashes.sha256}`;
    addCocEntry(null, 'Received (Import)', note);
  }
}

function readAsDataURL(file){
  return new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

function normalizeTags(tags){
  const out = {};
  for(const k in tags){
    const t = tags[k];
    try {
      out[k] = (t && (t.description || t.value || t.format || t.tagType)) || t;
    } catch(e) {
      out[k] = String(t);
    }
  }
  // GPS handling
  try {
    if(tags.GPSLatitude && tags.GPSLongitude){
      const lat = dmsToDecimal(tags.GPSLatitude.value || tags.GPSLatitude, (tags.GPSLatitudeRef && tags.GPSLatitudeRef.value) ? tags.GPSLatitudeRef.value : '');
      const lon = dmsToDecimal(tags.GPSLongitude.value || tags.GPSLongitude, (tags.GPSLongitudeRef && tags.GPSLongitudeRef.value) ? tags.GPSLongitudeRef.value : '');
      out._latitude = lat;
      out._longitude = lon;
    }
  } catch(e){}
  return out;
}
function dmsToDecimal(dms, ref){
  try {
    const vals = dms.map(x => (x && x.value) ? Number(x.value) : Number(x));
    let dec = vals[0] + vals[1]/60 + vals[2]/3600;
    if(ref === 'S' || ref === 'W') dec = -dec;
    return dec;
  } catch(e){ return null; }
}

/* ================ Update UI pieces ================ */
function updateBasicInfo(file){
  const sizeKB = (file.size/1024).toFixed(1);
  const modDate = new Date(file.lastModified).toLocaleString();
  document.getElementById('basicInfo').textContent = `Name: ${file.name} ‚Ä¢ Type: ${file.type || 'N/A'} ‚Ä¢ Size: ${sizeKB} KB ‚Ä¢ Modified: ${modDate}`;
}

function renderFields(metadata){
  // GPS
  if(metadata._latitude && metadata._longitude){
    document.getElementById('gpsWrap').classList.remove('hidden');
    document.getElementById('gpsText').textContent = `Lat: ${metadata._latitude.toFixed(6)}, Lon: ${metadata._longitude.toFixed(6)}`;
    document.getElementById('gpsLink').href = `https://www.google.com/maps?q=${metadata._latitude},${metadata._longitude}`;
    if(!gpsMap){
      gpsMap = L.map('map').setView([metadata._latitude, metadata._longitude], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(gpsMap);
      gpsMarker = L.marker([metadata._latitude, metadata._longitude]).addTo(gpsMap);
    } else {
      gpsMap.setView([metadata._latitude, metadata._longitude], 14);
      gpsMarker.setLatLng([metadata._latitude, metadata._longitude]);
    }
  } else {
    document.getElementById('gpsWrap').classList.add('hidden');
  }
}

/* ================ Metadata rendering & hidden metadata text ================ */
function renderMetadataCards(metadata){
  const wrap = document.getElementById('metadataCards');
  wrap.innerHTML = '';
  document.getElementById('rawJsonWrap').classList.remove('hidden');

  // Insert hash block first
  if(lastHashes.md5 || lastHashes.sha1 || lastHashes.sha256){
    const title = document.createElement('div'); title.className = 'small muted mb-2'; title.textContent = 'File hash values';
    wrap.appendChild(title);
    const hashFields = { 'MD5': lastHashes.md5, 'SHA-1': lastHashes.sha1, 'SHA-256': lastHashes.sha256 };
    for(const h in hashFields){
      const div = document.createElement('div'); div.className = 'metadata-card';
      div.innerHTML = `<div class="metadata-key">${h}</div><div class="metadata-value">${hashFields[h] || '-'}</div>`;
      wrap.appendChild(div);
    }
    const sep = document.createElement('div'); sep.style.height='8px'; wrap.appendChild(sep);
  }

  // order keys
  const order = ['Model','Make','BodySerialNumber','SerialNumber','DateTimeOriginal','ModifyDate','DateTime','Software','ImageDescription','ExifImageWidth','ExifImageHeight','GPSLatitude','GPSLongitude'];
  const keys = Object.keys(metadata).sort((a,b) => {
    const ai = order.indexOf(a), bi = order.indexOf(b);
    if(ai === -1 && bi === -1) return a.localeCompare(b);
    if(ai === -1) return 1; if(bi === -1) return -1; return ai - bi;
  });

  const metaText = [];
  for(const key of keys){
    const value = metadata[key];
    const card = document.createElement('div'); card.className = 'metadata-card';
    const kEl = document.createElement('div'); kEl.className = 'metadata-key'; kEl.textContent = key;
    const vEl = document.createElement('div'); vEl.className = 'metadata-value'; vEl.textContent = String(value);
    card.appendChild(kEl); card.appendChild(vEl); wrap.appendChild(card);
    metaText.push(`${key}: ${value}`);
  }

  // store for export (hidden)
  const metaTextEl = document.getElementById('metadata');
  metaTextEl.textContent = metaText.join('\n');
}

/* ================ Manipulation heuristics ================ */
function renderManipulationInfo(tags, hashes){
  document.getElementById('md5Val').textContent = hashes.md5 || '-';
  document.getElementById('sha1Val').textContent = hashes.sha1 || '-';
  document.getElementById('sha256Val').textContent = hashes.sha256 || '-';

  const apps = detectEditingApps(tags);
  document.getElementById('editApps').textContent = apps.length ? apps.join(', ') : 'None detected';

  const notes = computeManipulationNotes(tags, hashes);
  document.getElementById('manipNotes').textContent = notes;
}

function detectEditingApps(tags){
  const keys = ['Software','ProcessingSoftware','CreatorTool','ImageHistory','ApplicationRecord','HostComputer'];
  let raw = '';
  for(const k of keys){ if(tags[k]) raw += (tags[k].description ?? tags[k].value ?? String(tags[k])) + ' '; }
  if(!raw.trim()) return [];
  const s = raw.toLowerCase();
  const known = [
    {name:'Adobe Photoshop', terms:['photoshop','adobe']},
    {name:'Lightroom', terms:['lightroom']},
    {name:'GIMP', terms:['gimp']},
    {name:'Snapseed', terms:['snapseed']},
    {name:'Instagram', terms:['instagram']},
    {name:'Canva', terms:['canva']},
    {name:'PicsArt', terms:['picsart']},
    {name:'Affinity Photo', terms:['affinity']},
    {name:'Mobile Photos App', terms:['iphone','ios','android','photos','galaxy','pixel']}
  ];
  const found = [];
  for(const k of known){ for(const t of k.terms){ if(s.includes(t)){ found.push(k.name); break; } } }
  return Array.from(new Set(found.length ? found : [raw.trim()]));
}

function computeManipulationNotes(tags, hashes){
  const notes = [];
  const sw = tags.Software || tags.ProcessingSoftware || tags.CreatorTool;
  if(sw) notes.push('Software tag present ‚Äî inspect application listed.');
  else notes.push('No software/processing tag found (may be stripped).');

  try {
    const orig = (tags.DateTimeOriginal && (tags.DateTimeOriginal.description || tags.DateTimeOriginal.value));
    const mod = (tags.ModifyDate && (tags.ModifyDate.description || tags.ModifyDate.value)) || (tags.DateTime && (tags.DateTime.description || tags.DateTime.value));
    if(orig && mod){
      const o = Date.parse(String(orig).replace(/:/g,'-'));
      const m = Date.parse(String(mod).replace(/:/g,'-'));
      if(!isNaN(o) && !isNaN(m) && m > o + 60000) notes.push('ModifyDate later than DateTimeOriginal ‚Äî possible edit.');
    }
  } catch(e){}

  const thumb = !!(tags.JPEGThumbnail || tags.Thumbnail);
  if(!thumb) notes.push('No embedded thumbnail (could indicate metadata removal).');

  notes.push(`SHA-256: ${hashes.sha256 || 'N/A'}`);
  return notes.join(' ');
}

/* ================ ELA (Error Level Analysis) ================ */
async function runELA(imgEl, quality = 90){
  try {
    const width = imgEl.naturalWidth;
    const height = imgEl.naturalHeight;
    if(!width || !height) return 0;
    const maxDim = 1200;
    const scale = Math.min(1, maxDim / Math.max(width, height));
    const w = Math.round(width * scale);
    const h = Math.round(height * scale);

    const origCanvas = document.createElement('canvas'); origCanvas.width = w; origCanvas.height = h;
    const octx = origCanvas.getContext('2d'); octx.drawImage(imgEl, 0, 0, w, h);

    const jpegDataUrl = origCanvas.toDataURL('image/jpeg', quality/100);
    const recomImg = await new Promise(res => { const i = new Image(); i.onload = () => res(i); i.src = jpegDataUrl; });

    const recCanvas = document.createElement('canvas'); recCanvas.width = w; recCanvas.height = h;
    const rctx = recCanvas.getContext('2d'); rctx.drawImage(recomImg, 0, 0, w, h);

    const elaCanvas = document.getElementById('elaCanvas'); elaCanvas.width = w; elaCanvas.height = h;
    const dctx = elaCanvas.getContext('2d');

    const origData = octx.getImageData(0,0,w,h).data;
    const recData = rctx.getImageData(0,0,w,h).data;
    const diff = dctx.createImageData(w,h);
    let totalDiff = 0;
    for(let i=0;i<origData.length;i+=4){
      const dr = Math.abs(origData[i] - recData[i]);
      const dg = Math.abs(origData[i+1] - recData[i+1]);
      const db = Math.abs(origData[i+2] - recData[i+2]);
      const amp = 12;
      diff.data[i] = Math.min(255, dr * amp);
      diff.data[i+1] = Math.min(255, dg * amp);
      diff.data[i+2] = Math.min(255, db * amp);
      diff.data[i+3] = 255;
      totalDiff += (dr + dg + db) / 3;
    }
    dctx.putImageData(diff, 0, 0);
    const pixels = w*h;
    const meanDiff = totalDiff / pixels;
    const elaScore = Math.min(100, (meanDiff / 2));
    return elaScore;
  } catch(e) { console.warn('ELA error', e); return 0; }
}

/* ================ Hash helpers ================ */
async function computeSubtleHash(arrayBuffer, algo){
  try {
    const digest = await crypto.subtle.digest(algo, arrayBuffer);
    return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2,'0')).join('');
  } catch(e){ console.warn('digest error', e); return algo + '_err'; }
}
async function computeMD5(arrayBuffer){
  try {
    const wordArray = CryptoJS.lib.WordArray.create(arrayBuffer);
    return CryptoJS.MD5(wordArray).toString(CryptoJS.enc.Hex);
  } catch(e){ console.warn('md5 error', e); return 'md5_err'; }
}

/* ================ Export actions ================ */
document.getElementById('downloadMetaBtn').addEventListener('click', () => {
  if(!currentFile || !currentMetadata) return alert('Analyze a file first.');
  const payload = { fileName: currentFile.name, fileSize: currentFile.size, metadata: currentMetadata, hashes: lastHashes, caseId: selectedCaseId || null, timestamp: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${currentFile.name.replace(/\.[^/.]+$/,'')}_metadata.json`; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('copyMetaBtn').addEventListener('click', () => {
  if(!currentMetadata) return alert('Nothing to copy');
  navigator.clipboard.writeText(JSON.stringify(currentMetadata, null, 2));
  alert('Metadata copied to clipboard');
});
document.getElementById('downloadExcelBtn').addEventListener('click', () => {
  if(!currentFile || !currentMetadata) return alert('Analyze a file first.');
  const rows = (document.getElementById('metadata').textContent || '').split('\n').map(r => [r]);
  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Metadata');
  const fname = `${currentFile.name.replace(/\.[^/.]+$/,'')}_metadata.xlsx`;
  XLSX.writeFile(wb, fname);
});
document.getElementById('generatePdfBtn').addEventListener('click', async () => {
  if(!currentFile || !currentMetadata) return alert('Analyze a file first.');
  const report = document.createElement('div'); report.style.width='900px'; report.style.padding='16px'; report.style.background='white'; report.style.color='black';
  report.innerHTML = `<h1>META FORENSIC - Forensic Report</h1>
    <div><strong>Case:</strong> ${selectedCaseId || '(no case selected)'}</div>
    <div><strong>File:</strong> ${currentFile.name}</div>
    <hr/>
    <h3>Metadata</h3><pre style="white-space:pre-wrap;">${document.getElementById('metadata').textContent}</pre>
    <hr/>
    <h3>Manipulation</h3><div>${document.getElementById('manipNotes').textContent}</div>
    <hr/>
    <h3>Chain-of-Custody</h3>
    <div style="font-size:12px;">${selectedCaseId ? (cases.find(c=>c.id===selectedCaseId).coc.map(e => `<div><strong>${new Date(e.time).toLocaleString()}</strong> ‚Äî ${e.actor} ‚Äî ${e.action} ${e.note?('‚Äî '+e.note):''}</div>`).join('') ) : '(no case selected)'}</div>`;
  document.body.appendChild(report);
  const canvas = await html2canvas(report, { scale:2 });
  const imgData = canvas.toDataURL('image/jpeg', 0.9);
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit:'px', format:[canvas.width, canvas.height] });
  pdf.addImage(imgData,'JPEG',0,0,canvas.width,canvas.height);
  pdf.save(`forensic_report_${selectedCaseId || 'report'}.pdf`);
  document.body.removeChild(report);
});

/* Full JSON / PDF from Manip panel */
document.getElementById('downloadAllJsonBtn').addEventListener('click', () => {
  if(!currentFile || !currentMetadata) return alert('Analyze a file first.');
  const payload = {
    fileName: currentFile.name,
    fileSize: currentFile.size,
    metadata: currentMetadata,
    hashes: lastHashes,
    caseId: selectedCaseId || null,
    coc: selectedCaseId ? (cases.find(c=>c.id===selectedCaseId).coc || []) : [],
    timestamp: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${currentFile.name.replace(/\.[^/.]+$/,'')}_full_forensic.json`; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('downloadReportPdfBtn').addEventListener('click', async () => {
  if(!currentFile || !currentMetadata) return alert('Analyze a file first.');
  const report = document.createElement('div'); report.style.width='900px'; report.style.padding='16px'; report.style.background='white'; report.style.color='black';
  report.innerHTML = `<h1>META FORENSIC - Full Forensic Report</h1>
    <div><strong>Case:</strong> ${selectedCaseId || '(none)'}</div>
    <div><strong>File:</strong> ${currentFile.name}</div>
    <hr/>
    <h3>Metadata</h3><pre style="white-space:pre-wrap;">${document.getElementById('metadata').textContent}</pre>
    <hr/>
    <h3>Manipulation</h3><div>${document.getElementById('manipNotes').textContent}</div>
    <hr/>
    <h3>Chain-of-Custody</h3>
    <div style="font-size:12px;">${selectedCaseId ? (cases.find(c=>c.id===selectedCaseId).coc.map(e => `<div><strong>${new Date(e.time).toLocaleString()}</strong> ‚Äî ${e.actor} ‚Äî ${e.action} ${e.note ? '‚Äî ' + e.note : ''}</div>`).join('') ) : '(no case selected)'}</div>`;
  document.body.appendChild(report);
  const canvas = await html2canvas(report, { scale:2 });
  const imgData = canvas.toDataURL('image/jpeg', 0.9);
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit:'px', format:[canvas.width, canvas.height] });
  pdf.addImage(imgData,'JPEG',0,0,canvas.width,canvas.height);
  pdf.save(`forensic_report_${selectedCaseId || 'report'}.pdf`);
  document.body.removeChild(report);
});

/* ================ Utilities ================ */
function renderManipulationInfo(tags, hashes){
  // show hash values & manipulation outputs
  document.getElementById('md5Val').textContent = hashes.md5 || '-';
  document.getElementById('sha1Val').textContent = hashes.sha1 || '-';
  document.getElementById('sha256Val').textContent = hashes.sha256 || '-';
  const apps = detectEditingApps(tags);
  document.getElementById('editApps').textContent = apps.length ? apps.join(', ') : 'None detected';
  const notes = computeManipulationNotes(tags, hashes);
  document.getElementById('manipNotes').textContent = notes;
}

/* Boot */
function init(){
  refreshCaseList();
  document.getElementById('panel-metadata').classList.remove('hidden');
  document.getElementById('menuMetadata').classList.add('active');
}
init();

</script>
</body>
</html>
