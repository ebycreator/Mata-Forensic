<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>META FORENSIC ‚Äî Forensic Image Analyzer</title>

  <!-- Tailwind for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ExifReader -->
  <script src="https://cdn.jsdelivr.net/npm/exifreader@4.12.0/dist/exif-reader.min.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- CryptoJS for MD5 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <!-- SheetJS for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- jsPDF + html2canvas for PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    /* Premium dark forensic theme */
    :root{
      --bg: #071126;
      --card: rgba(255,255,255,0.04);
      --muted: #9aa8b8;
      --accent: #35b3ff;
      --glass: rgba(255,255,255,0.03);
    }
    html,body { height:100%; background: linear-gradient(180deg,#041021 0%, #08182a 60%), url('https://images.unsplash.com/photo-1616401785984-ded538da8c10?auto=format&fit=crop&w=1920&q=80') center/cover no-repeat; color:#e6f0f7; font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; }
    .container { max-width:1200px; margin:28px auto; padding:20px; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px; }
    .brand { display:flex; gap:12px; align-items:center;}
    .brand .logo { width:56px; height:56px; border-radius:10px; background:linear-gradient(135deg,var(--accent),#8be1ff); display:flex; align-items:center; justify-content:center; color:#021022; font-weight:800; font-size:18px; box-shadow:0 6px 24px rgba(0,0,0,0.6);}
    .card { background: var(--card); border: 1px solid rgba(255,255,255,0.04); padding:14px; border-radius:12px; box-shadow: 0 6px 20px rgba(2,8,23,0.6); }
    .muted { color:var(--muted); }
    .controls .btn { background:var(--accent); color:#021022; padding:8px 12px; border-radius:8px; font-weight:700; cursor:pointer; }
    .dropzone { border:2px dashed rgba(255,255,255,0.06); padding:18px; border-radius:10px; text-align:center; cursor:pointer; }
    .preview-img { max-width:260px; max-height:260px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); }
    /* accordion */
    .accordion-item { border-radius:10px; overflow:hidden; margin-bottom:10px; border:1px solid rgba(255,255,255,0.03); }
    .accordion-header { display:flex; justify-content:space-between; align-items:center; padding:10px 14px; cursor:pointer; background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }
    .accordion-body { padding:12px 14px; border-top:1px solid rgba(255,255,255,0.02); display:none; }
    .k { color:var(--muted); font-weight:600; }
    .kv { color:#e6f0f7; text-align:right; word-break:break-word; }
    .metadata-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .mapbox { height:260px; border-radius:8px; overflow:hidden; border:1px solid rgba(255,255,255,0.03); }
    .small-muted { color:var(--muted); font-size:13px; }
    .hash-code { font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Roboto Mono,monospace; font-size:12px; color:#bfe9ff; background:rgba(255,255,255,0.02); padding:6px;border-radius:6px; word-break:break-all; }
    @media (max-width: 900px) {
      .metadata-grid { grid-template-columns: 1fr; }
      .topbar { flex-direction:column; align-items:flex-start; gap:12px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="logo">MF</div>
        <div>
          <div style="font-size:18px;font-weight:800">META FORENSIC</div>
          <div class="small-muted">Digital Forensic ‚Äî Image Metadata & Triage</div>
        </div>
      </div>

      <div class="controls flex gap-3">
        <button id="exportJsonBtn" class="btn">Export JSON</button>
        <button id="exportExcelBtn" class="btn">Export Excel</button>
        <button id="generatePdfBtn" class="btn">Generate PDF (with image)</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left: Upload + Preview + Case -->
      <div class="col-span-1">
        <div class="card">
          <div class="dropzone" id="dropzone">
            <input id="fileInput" type="file" accept="image/*" style="display:none" />
            <div class="muted">Drag & drop an image here or</div>
            <div style="margin-top:10px">
              <button id="chooseBtn" class="btn">Choose Image</button>
            </div>
            <div class="small-muted mt-3">Recommended: JPEG for full EXIF. HEIC support varies by browser.</div>
          </div>

          <div id="previewBox" class="mt-4" style="display:none;">
            <div class="flex gap-4 items-start">
              <img id="preview" class="preview-img" src="" alt="preview">
              <div style="flex:1">
                <div class="k">File</div>
                <div id="fileInfo" class="small-muted">‚Äî</div>
                <div class="mt-3">
                  <button id="copyMetaBtn" class="btn" style="background:#8be1ff;color:#021022">Copy Metadata</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Case management -->
        <div class="card mt-4">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div><strong>üóÇ Case Management</strong></div>
            <div class="small-muted">Auto-fill CoC</div>
          </div>
          <div class="mt-3 space-y-2">
            <input id="caseId" placeholder="Case ID (auto if blank)" class="w-full p-2 rounded bg-transparent border border-white/5" />
            <input id="evidenceId" placeholder="Evidence ID" class="w-full p-2 rounded bg-transparent border border-white/5" />
            <input id="officer" placeholder="Officer name" class="w-full p-2 rounded bg-transparent border border-white/5" />
            <input id="suspect" placeholder="Suspect name" class="w-full p-2 rounded bg-transparent border border-white/5" />
            <input id="victim" placeholder="Victim name" class="w-full p-2 rounded bg-transparent border border-white/5" />
            <div class="flex gap-2">
              <button id="createCaseBtn" class="btn">Create Case</button>
              <button id="clearCaseBtn" class="btn" style="background:#ff9f43">Clear</button>
            </div>
            <div id="caseSummary" class="small-muted mt-2">No case created.</div>
          </div>
        </div>

        <!-- Chain of custody -->
        <div class="card mt-4">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div><strong>üìù Chain of Custody</strong></div>
            <div class="small-muted">Timeline</div>
          </div>
          <div id="cocTimeline" class="mt-3 space-y-2 small-muted" style="max-height:260px; overflow:auto;">
            (no entries)
          </div>
          <div class="mt-3">
            <input id="cocActor" placeholder="Actor (auto)" class="w-full p-2 rounded bg-transparent border border-white/5" />
            <select id="cocAction" class="w-full p-2 rounded bg-transparent border border-white/5 mt-2">
              <option>Collected</option><option>Received</option><option>Transferred</option><option>Analyzed</option><option>Stored</option><option>Returned</option><option>Other</option>
            </select>
            <input id="cocNote" placeholder="Note (optional)" class="w-full p-2 rounded bg-transparent border border-white/5 mt-2" />
            <div class="flex gap-2 mt-2">
              <button id="addCocBtn" class="btn">Add Entry</button>
              <button id="exportCocBtn" class="btn" style="background:#9affc9;color:#021022">Export CoC</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Middle: Metadata accordions -->
      <div class="col-span-1 lg:col-span-2">
        <div class="card mb-4">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div><strong>üìÅ Forensic Metadata & Analysis</strong></div>
            <div class="small-muted">Hybrid view ‚Äî table & cards</div>
          </div>

          <div class="mt-4 metadata-grid">
            <!-- Left column: accordion -->
            <div>
              <!-- General -->
              <div class="accordion-item" id="acc-general">
                <div class="accordion-header" data-target="body-general">
                  <div><strong>üìÑ General</strong></div>
                  <div class="small-muted">file ‚Ä¢ size ‚Ä¢ type</div>
                </div>
                <div class="accordion-body" id="body-general">
                  <div class="grid grid-cols-2 gap-2">
                    <div class="k">File name</div><div id="m-filename" class="kv">‚Äî</div>
                    <div class="k">MIME type</div><div id="m-mime" class="kv">‚Äî</div>
                    <div class="k">Size</div><div id="m-size" class="kv">‚Äî</div>
                    <div class="k">Last modified</div><div id="m-lastmod" class="kv">‚Äî</div>
                  </div>
                </div>
              </div>

              <!-- Camera -->
              <div class="accordion-item" id="acc-camera">
                <div class="accordion-header" data-target="body-camera">
                  <div><strong>üì∏ Camera / Device</strong></div>
                  <div class="small-muted">model ‚Ä¢ serial ‚Ä¢ lens</div>
                </div>
                <div class="accordion-body" id="body-camera">
                  <div class="grid grid-cols-2 gap-2">
                    <div class="k">Make</div><div id="m-make" class="kv">‚Äî</div>
                    <div class="k">Model</div><div id="m-model" class="kv">‚Äî</div>
                    <div class="k">Camera Serial</div><div id="m-serial" class="kv">‚Äî</div>
                    <div class="k">Software</div><div id="m-software" class="kv">‚Äî</div>
                    <div class="k">Lens</div><div id="m-lens" class="kv">‚Äî</div>
                  </div>
                </div>
              </div>

              <!-- Timestamps -->
              <div class="accordion-item" id="acc-time">
                <div class="accordion-header" data-target="body-time">
                  <div><strong>‚è± Timestamps</strong></div>
                  <div class="small-muted">original ‚Ä¢ digitized ‚Ä¢ modified</div>
                </div>
                <div class="accordion-body" id="body-time">
                  <div class="grid grid-cols-2 gap-2">
                    <div class="k">Original Date/Time</div><div id="m-original" class="kv">‚Äî</div>
                    <div class="k">Digitized</div><div id="m-digitized" class="kv">‚Äî</div>
                    <div class="k">Modified</div><div id="m-modified" class="kv">‚Äî</div>
                    <div class="k">Exif Offset</div><div id="m-offset" class="kv">‚Äî</div>
                  </div>
                </div>
              </div>

              <!-- GPS -->
              <div class="accordion-item" id="acc-gps">
                <div class="accordion-header" data-target="body-gps">
                  <div>üó∫Ô∏è GPS</div>
                  <div class="small-muted">coordinates & map</div>
                </div>
                <div class="accordion-body" id="body-gps">
                  <div class="grid grid-cols-2 gap-2">
                    <div class="k">Latitude</div><div id="m-lat" class="kv">‚Äî</div>
                    <div class="k">Longitude</div><div id="m-lng" class="kv">‚Äî</div>
                    <div class="k">Altitude</div><div id="m-alt" class="kv">‚Äî</div>
                    <div class="k">GPS Precision</div><div id="m-precision" class="kv">‚Äî</div>
                  </div>
                  <div class="mapbox mt-3" id="gpsMap"></div>
                </div>
              </div>

              <!-- Hashes -->
              <div class="accordion-item" id="acc-hash">
                <div class="accordion-header" data-target="body-hash">
                  <div>üîê Hashes</div>
                  <div class="small-muted">MD5 ‚Ä¢ SHA-1 ‚Ä¢ SHA-256</div>
                </div>
                <div class="accordion-body" id="body-hash">
                  <div class="space-y-2">
                    <div class="k">MD5</div><div id="m-md5" class="hash-code">‚Äî</div>
                    <div class="k">SHA-1</div><div id="m-sha1" class="hash-code">‚Äî</div>
                    <div class="k">SHA-256</div><div id="m-sha256" class="hash-code">‚Äî</div>
                  </div>
                </div>
              </div>

              <!-- Manipulation -->
              <div class="accordion-item" id="acc-manip">
                <div class="accordion-header" data-target="body-manip">
                  <div>ü§ñ AI / Manipulation</div>
                  <div class="small-muted">ELA & heuristics</div>
                </div>
                <div class="accordion-body" id="body-manip">
                  <div class="k">Detected Editing Apps</div><div id="m-editapps" class="kv">‚Äî</div>
                  <div class="k mt-2">Heuristic Notes</div><div id="m-notes" class="kv">‚Äî</div>
                </div>
              </div>
            </div>

            <!-- Right column: quick summary card -->
            <div>
              <div class="card">
                <div style="display:flex;align-items:center;gap:10px;">
                  <div style="font-size:22px">üìã Summary</div>
                  <div class="small-muted">Instant triage</div>
                </div>
                <div class="mt-3 small-muted">
                  <div><strong>ELA Score:</strong> <span id="elaScore">‚Äî</span></div>
                  <div><strong>Manipulation Risk:</strong> <span id="riskScore">‚Äî</span></div>
                  <div><strong>Camera Present:</strong> <span id="cameraPresent">‚Äî</span></div>
                  <div class="mt-3"><strong>Selected Case:</strong> <span id="selCase">none</span></div>
                </div>
              </div>

              <div class="card mt-4">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <div><strong>Quick Actions</strong></div>
                </div>
                <div class="mt-3 flex gap-2">
                  <button id="quickCoCImport" class="btn">Log Import</button>
                  <button id="quickGeneratePdf" class="btn">PDF</button>
                </div>
                <div class="mt-3 small-muted">
                  Use PDF to create court-ready report (includes thumbnail).
                </div>
              </div>
            </div>

          </div> <!-- metadata-grid -->
        </div> <!-- card -->
      </div>
    </div> <!-- grid -->

    <div class="mt-6 small-muted text-center">Built for investigators ‚Ä¢ For demonstration only ‚Äî use verified tools for court evidence.</div>
  </div>

<script>
/* ================== App state ================== */
let currentFile = null;
let currentArrayBuffer = null;
let currentMetadata = null;
let gpsMap = null;
let gpsMarker = null;
let cocEntries = [];
let currentCase = null;
let lastHashes = { md5:null, sha1:null, sha256:null };

/* ===== UI refs ===== */
const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInput');
const chooseBtn = document.getElementById('chooseBtn');
const previewBox = document.getElementById('previewBox');
const preview = document.getElementById('preview');
const fileInfo = document.getElementById('fileInfo');

const mFilename = document.getElementById('m-filename');
const mMime = document.getElementById('m-mime');
const mSize = document.getElementById('m-size');
const mLast = document.getElementById('m-lastmod');

const mMake = document.getElementById('m-make');
const mModel = document.getElementById('m-model');
const mSerial = document.getElementById('m-serial');
const mSoftware = document.getElementById('m-software');
const mLens = document.getElementById('m-lens');

const mOriginal = document.getElementById('m-original');
const mDigitized = document.getElementById('m-digitized');
const mModified = document.getElementById('m-modified');
const mOffset = document.getElementById('m-offset');

const mLat = document.getElementById('m-lat');
const mLng = document.getElementById('m-lng');
const mAlt = document.getElementById('m-alt');
const mPrec = document.getElementById('m-precision');

const mMd5 = document.getElementById('m-md5');
const mSha1 = document.getElementById('m-sha1');
const mSha256 = document.getElementById('m-sha256');

const mEditApps = document.getElementById('m-editapps');
const mNotes = document.getElementById('m-notes');

const elaScoreEl = document.getElementById('elaScore');
const riskScoreEl = document.getElementById('riskScore');
const cameraPresentEl = document.getElementById('cameraPresent');

const caseIdInput = document.getElementById('caseId');
const evidenceIdInput = document.getElementById('evidenceId');
const officerInput = document.getElementById('officer');
const suspectInput = document.getElementById('suspect');
const victimInput = document.getElementById('victim');
const createCaseBtn = document.getElementById('createCaseBtn');
const clearCaseBtn = document.getElementById('clearCaseBtn');
const caseSummary = document.getElementById('caseSummary');

const cocTimeline = document.getElementById('cocTimeline');
const cocActor = document.getElementById('cocActor');
const cocAction = document.getElementById('cocAction');
const cocNote = document.getElementById('cocNote');
const addCocBtn = document.getElementById('addCocBtn');
const exportCocBtn = document.getElementById('exportCocBtn');

const exportJsonBtn = document.getElementById('exportJsonBtn');
const exportExcelBtn = document.getElementById('exportExcelBtn');
const generatePdfBtn = document.getElementById('generatePdfBtn');

const copyMetaBtn = document.getElementById('copyMetaBtn');
const quickCoCImport = document.getElementById('quickCoCImport');
const quickGeneratePdf = document.getElementById('quickGeneratePdf');

/* ===== Accordion behaviour ===== */
document.querySelectorAll('.accordion-header').forEach(h=>{
  h.addEventListener('click', ()=>{
    const id = h.dataset.target;
    const body = document.getElementById(id);
    const visible = body.style.display === 'block';
    // close others optionally
    document.querySelectorAll('.accordion-body').forEach(b=>b.style.display = 'none');
    body.style.display = visible ? 'none' : 'block';
  });
});

/* ===== File drop/select ===== */
chooseBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', (e)=> { if(e.target.files && e.target.files[0]) handleFile(e.target.files[0]); });

['dragenter','dragover'].forEach(ev=>{
  dropzone.addEventListener(ev, (e)=> { e.preventDefault(); dropzone.style.borderColor = 'rgba(139,225,255,0.8)'; });
});
['dragleave','drop'].forEach(ev=>{
  dropzone.addEventListener(ev, (e)=> { e.preventDefault(); dropzone.style.borderColor = ''; });
});
dropzone.addEventListener('drop', (e)=>{
  e.preventDefault();
  dropzone.style.borderColor = '';
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if(f) handleFile(f);
});

/* ===== Utilities ===== */
function readAsArrayBuffer(file){ return file.arrayBuffer(); }
function readAsDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

function toDecimalFromEXIF(value){
  if(!value) return null;
  if(Array.isArray(value)) {
    const parts = value.map(v => (typeof v === 'object' && 'value' in v) ? Number(v.value) : Number(v));
    return parts[0] + (parts[1]||0)/60 + (parts[2]||0)/3600;
  }
  if(typeof value === 'string'){
    const parts = value.split(',').map(p=>p.trim());
    return parts.map(p=> { const f=p.split('/'); return f.length===2?Number(f[0])/Number(f[1]) : Number(p); })[0];
  }
  return Number(value);
}

/* ===== Hash helpers ===== */
async function computeSubtleHash(buf, algo){
  try {
    const digest = await crypto.subtle.digest(algo, buf);
    return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join('');
  } catch(e){ console.warn('subtle digest error', e); return algo + '_err'; }
}
function computeMD5(buf){
  try {
    // CryptoJS expects WordArray; convert
    const wordArray = CryptoJS.lib.WordArray.create(buf);
    return CryptoJS.MD5(wordArray).toString(CryptoJS.enc.Hex);
  } catch(e){ console.warn('md5 err', e); return 'md5_err'; }
}

/* ===== Handle file ===== */
async function handleFile(file){
  currentFile = file;
  currentArrayBuffer = await readAsArrayBuffer(file);
  const dataURL = await readAsDataURL(file);

  // Show preview
  preview.src = dataURL;
  previewBox.style.display = 'block';
  fileInfo.textContent = `${file.name} ‚Ä¢ ${(file.size/1024).toFixed(1)} KB ‚Ä¢ ${file.type || 'N/A'}`;

  // parse EXIF
  let tags = {};
  try {
    tags = ExifReader.load(currentArrayBuffer, { expanded: true });
  } catch(e) {
    console.warn('ExifReader failed', e);
    tags = {};
  }

  // normalize and display metadata
  currentMetadata = buildMetadataObject(file, tags);

  // compute hashes
  lastHashes.md5 = computeMD5(currentArrayBuffer);
  lastHashes.sha1 = await computeSubtleHash(currentArrayBuffer, 'SHA-1');
  lastHashes.sha256 = await computeSubtleHash(currentArrayBuffer, 'SHA-256');

  // store hashes in metadata object
  currentMetadata.hashes = { ...lastHashes };

  // display in UI
  renderAll(currentMetadata, tags);

  // auto CoC logging if case selected
  if(currentCase) {
    const note = `Imported file ${file.name} (${(file.size/1024).toFixed(1)} KB) SHA-256: ${lastHashes.sha256}`;
    addCocEntry(cocActor.value || currentCase.officer || 'Unknown', 'Imported', note, true);
  }
}

/* ===== build normalized metadata object ===== */
function buildMetadataObject(file, tags){
  const out = {};
  out.fileName = file.name;
  out.fileSize = `${(file.size/1024).toFixed(1)} KB`;
  out.mimeType = file.type || 'N/A';
  out.lastModified = new Date(file.lastModified).toLocaleString();

  // camera / device
  out.make = tags.Make && (tags.Make.description || tags.Make.value) || '';
  out.model = tags.Model && (tags.Model.description || tags.Model.value) || '';
  out.serial = (tags.BodySerialNumber && (tags.BodySerialNumber.description || tags.BodySerialNumber.value)) || (tags.SerialNumber && (tags.SerialNumber.description || tags.SerialNumber.value)) || '';
  out.software = (tags.Software && (tags.Software.description || tags.Software.value)) || '';
  out.lens = (tags.LensModel && (tags.LensModel.description || tags.LensModel.value)) || '';

  // dates
  out.dateOriginal = (tags.DateTimeOriginal && (tags.DateTimeOriginal.description || tags.DateTimeOriginal.value)) || '';
  out.dateDigitized = (tags.CreateDate && (tags.CreateDate.description || tags.CreateDate.value)) || '';
  out.dateModified = (tags.ModifyDate && (tags.ModifyDate.description || tags.ModifyDate.value)) || (tags.DateTime && (tags.DateTime.description || tags.DateTime.value)) || '';

  // GPS
  try {
    if(tags.GPSLatitude && tags.GPSLongitude){
      const lat = toDecimalFromEXIF(tags.GPSLatitude.value || tags.GPSLatitude);
      const lon = toDecimalFromEXIF(tags.GPSLongitude.value || tags.GPSLongitude);
      const latRef = (tags.GPSLatitudeRef && (tags.GPSLatitudeRef.value || tags.GPSLatitudeRef.description)) || '';
      const lonRef = (tags.GPSLongitudeRef && (tags.GPSLongitudeRef.value || tags.GPSLongitudeRef.description)) || '';
      out.latitude = lat ? (latRef === 'S' ? -Math.abs(lat) : lat) : null;
      out.longitude = lon ? (lonRef === 'W' ? -Math.abs(lon) : lon) : null;
      out.altitude = (tags.GPSAltitude && (tags.GPSAltitude.description || tags.GPSAltitude.value)) || '';
      out.gpsPrecision = (tags.GPSDOP && (tags.GPSDOP.description || tags.GPSDOP.value)) || '';
    } else {
      out.latitude = null; out.longitude = null; out.altitude = ''; out.gpsPrecision = '';
    }
  } catch(e){ out.latitude = null; out.longitude = null; out.altitude = ''; out.gpsPrecision = ''; }

  // thumbnail presence
  out.hasThumbnail = !!(tags.JPEGThumbnail || tags.Thumbnail);

  // raw tags pass-through (for JSON export)
  out._raw = tags;

  return out;
}

/* ===== Render to UI ===== */
function renderAll(meta, tags){
  // General
  mFilename.textContent = meta.fileName || '‚Äî';
  mMime.textContent = meta.mimeType || '‚Äî';
  mSize.textContent = meta.fileSize || '‚Äî';
  mLast.textContent = meta.lastModified || '‚Äî';

  // Camera
  mMake.textContent = meta.make || '‚Äî';
  mModel.textContent = meta.model || '‚Äî';
  mSerial.textContent = meta.serial || '‚Äî';
  mSoftware.textContent = meta.software || '‚Äî';
  mLens.textContent = meta.lens || '‚Äî';
  cameraPresentEl.textContent = (meta.model || meta.make) ? 'Yes' : 'No';

  // Timestamps
  mOriginal.textContent = meta.dateOriginal || '‚Äî';
  mDigitized.textContent = meta.dateDigitized || '‚Äî';
  mModified.textContent = meta.dateModified || '‚Äî';
  mOffset.textContent = tags.OffsetTime || tags.TimeZone || '‚Äî';

  // GPS
  if(meta.latitude && meta.longitude){
    mLat.textContent = Number(meta.latitude).toFixed(6);
    mLng.textContent = Number(meta.longitude).toFixed(6);
    mAlt.textContent = meta.altitude || '‚Äî';
    mPrec.textContent = meta.gpsPrecision || '‚Äî';
    showMap(meta.latitude, meta.longitude);
  } else {
    mLat.textContent = '‚Äî'; mLng.textContent = '‚Äî'; mAlt.textContent='‚Äî'; mPrec.textContent='‚Äî';
    hideMap();
  }

  // Hashes
  mMd5.textContent = lastHashes.md5 || '‚Äî';
  mSha1.textContent = lastHashes.sha1 || '‚Äî';
  mSha256.textContent = lastHashes.sha256 || '‚Äî';

  // Edit apps detect
  const apps = detectEditingApps(tags);
  mEditApps.textContent = apps.length ? apps.join(', ') : 'None detected';

  // Heuristic notes
  const notes = computeManipulationNotes(tags, lastHashes);
  mNotes.textContent = Array.isArray(notes) ? notes.join(' | ') : notes;

  // ELA placeholder (fast heuristic: use thumbnail absence + software presence)
  const elaScore = heuristicELAScore(tags);
  const risk = computeRiskFromHeuristics(tags, elaScore);
  elaScoreEl.textContent = elaScore.toFixed(1);
  riskScoreEl.textContent = risk;

  // store for export
  currentMetadata = meta;
}

/* ===== Map helpers ===== */
function showMap(lat, lng){
  const el = document.getElementById('gpsMap');
  el.style.display = 'block';
  if(!gpsMap){
    gpsMap = L.map('gpsMap', { zoomControl:false }).setView([lat, lng], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(gpsMap);
    gpsMarker = L.marker([lat, lng]).addTo(gpsMap);
  } else {
    gpsMap.setView([lat, lng], 15);
    if(!gpsMarker) gpsMarker = L.marker([lat, lng]).addTo(gpsMap); else gpsMarker.setLatLng([lat, lng]);
  }
}
function hideMap(){
  const el = document.getElementById('gpsMap');
  el.style.display = 'none';
}

/* ===== Detection heuristics ===== */
function detectEditingApps(tags){
  const fields = ['Software','ProcessingSoftware','CreatorTool','ImageHistory','ApplicationRecord','HostComputer'];
  let raw = '';
  for(const f of fields){
    if(tags[f]) raw += ' ' + (tags[f].description || tags[f].value || String(tags[f]));
  }
  raw = raw.trim().toLowerCase();
  if(!raw) return [];
  const known = [
    {name:'Adobe Photoshop', terms:['photoshop','adobe']},
    {name:'Lightroom', terms:['lightroom']},
    {name:'GIMP', terms:['gimp']},
    {name:'Snapseed', terms:['snapseed']},
    {name:'Canva', terms:['canva']},
    {name:'Instagram', terms:['instagram']},
    {name:'Phone Photos App', terms:['iphone','android','pixel','galaxy','photos']},
  ];
  const found=[];
  for(const k of known){
    for(const t of k.terms) if(raw.includes(t)){ found.push(k.name); break; }
  }
  return found.length ? Array.from(new Set(found)) : [raw.slice(0,60)];
}

function computeManipulationNotes(tags, hashes){
  const notes = [];
  if(tags.Software || tags.ProcessingSoftware) notes.push('Software tag present');
  else notes.push('No software tag');
  // thumbnail
  if(!tags.JPEGThumbnail && !tags.Thumbnail) notes.push('No embedded thumbnail');
  // date mismatch
  try {
    const orig = tags.DateTimeOriginal && (tags.DateTimeOriginal.description || tags.DateTimeOriginal.value);
    const mod = (tags.ModifyDate && (tags.ModifyDate.description || tags.ModifyDate.value)) || (tags.DateTime && (tags.DateTime.description || tags.DateTime.value));
    if(orig && mod){
      const o = Date.parse(String(orig).replace(/:/g,'-'));
      const m = Date.parse(String(mod).replace(/:/g,'-'));
      if(!isNaN(o) && !isNaN(m) && m > o + 60000) notes.push('ModifyDate later than Original ‚Äî possible edit');
    }
  } catch(e){}
  notes.push(`SHA-256: ${hashes.sha256 || 'N/A'}`);
  return notes;
}

function heuristicELAScore(tags){
  // Simple heuristic: if thumbnail missing and software present -> higher ELA suspicion
  let score = 5;
  if(!tags.JPEGThumbnail && !tags.Thumbnail) score += 18;
  if(tags.Software || tags.ProcessingSoftware) score += 12;
  if(!tags.Model || !tags.Make) score += 6;
  // clamp 0..100
  return Math.min(100, score);
}

function computeRiskFromHeuristics(tags, ela){
  let score = Math.round(Math.min(100, ela * 0.8));
  if(!tags.Model) score += 8;
  if(!tags.BodySerialNumber && !tags.SerialNumber) score += 6;
  return score;
}

/* ===== Case / CoC handling ===== */
createCaseBtn.addEventListener('click', ()=>{
  const id = caseIdInput.value.trim() || 'CASE-' + Date.now().toString().slice(-8);
  currentCase = {
    id,
    evidence: evidenceIdInput.value.trim() || '',
    officer: officerInput.value.trim() || '',
    suspect: suspectInput.value.trim() || '',
    victim: victimInput.value.trim() || '',
    created: new Date().toISOString(),
    coc: []
  };
  caseSummary.innerHTML = `<strong>${currentCase.id}</strong> ‚Ä¢ Evidence: ${currentCase.evidence || '(none)'} ‚Ä¢ Officer: ${currentCase.officer || '(none)'}`;
  document.getElementById('selCase').textContent = currentCase.id;
  // clear inputs
  caseIdInput.value=''; evidenceIdInput.value=''; officerInput.value=''; suspectInput.value=''; victimInput.value='';
  // auto log creation
  addCocEntry(currentCase.officer || 'System', 'Case Created', `Case ${currentCase.id} created`, false);
});

clearCaseBtn.addEventListener('click', ()=>{
  if(!confirm('Clear current case and CoC?')) return;
  currentCase = null; caseSummary.textContent = 'No case created.'; document.getElementById('selCase').textContent = 'none';
  cocEntries = []; renderCoc();
});

/* Chain-of-custody functions */
function addCocEntry(actor, action, note, skipRender=false){
  const entry = { actor: actor || 'Unknown', action, note: note || '', time: new Date().toISOString() };
  cocEntries.unshift(entry); // newest first
  // also push to case if available
  if(currentCase){
    currentCase.coc = currentCase.coc || [];
    currentCase.coc.unshift(entry);
  }
  if(!skipRender) renderCoc();
}
addCocBtn.addEventListener('click', ()=> {
  addCocEntry(cocActor.value || (currentCase && currentCase.officer) || 'Unknown', cocAction.value, cocNote.value.trim());
  cocNote.value=''; cocActor.value='';
});
exportCocBtn.addEventListener('click', ()=>{
  if(!currentCase) return alert('Create/select a case first.');
  const blob = new Blob([JSON.stringify(currentCase, null, 2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `CoC_${currentCase.id}.json`; a.click(); URL.revokeObjectURL(a.href);
});
function renderCoc(){
  if(cocEntries.length===0) cocTimeline.innerHTML = '(no entries)';
  else {
    cocTimeline.innerHTML = '';
    for(const e of cocEntries){
      const d = document.createElement('div');
      d.className = 'p-2 border-b border-white/5';
      d.innerHTML = `<div style="font-weight:700">${e.action} ‚Äî ${e.actor}</div><div class="small-muted">${new Date(e.time).toLocaleString()}</div><div style="margin-top:6px">${e.note || ''}</div>`;
      cocTimeline.appendChild(d);
    }
  }
}

/* Quick import log */
quickCoCImport.addEventListener('click', ()=> {
  if(!currentFile) return alert('Import a file first.');
  addCocEntry((currentCase && currentCase.officer) || 'Unknown', 'Imported (manual)', `Manual import of ${currentFile.name}`);
});

/* ===== Exports: JSON, Excel, PDF ===== */
exportJsonBtn.addEventListener('click', ()=>{
  if(!currentFile || !currentMetadata) return alert('Analyze a file first.');
  const payload = { case: currentCase || null, metadata: currentMetadata, hashes: lastHashes, coc: currentCase ? currentCase.coc : cocEntries };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${(currentFile.name || 'image').replace(/\.[^/.]+$/,'')}_forensic.json`; a.click(); URL.revokeObjectURL(a.href);
});

exportExcelBtn.addEventListener('click', ()=>{
  if(!currentFile || !currentMetadata) return alert('Analyze a file first.');
  // Build rows: key, value
  const rows = [
    ['File Name', currentMetadata.fileName],
    ['File Size', currentMetadata.fileSize],
    ['MIME', currentMetadata.mimeType],
    ['Make', currentMetadata.make],
    ['Model', currentMetadata.model],
    ['Serial', currentMetadata.serial],
    ['Original Date', currentMetadata.dateOriginal],
    ['Modified Date', currentMetadata.dateModified],
    ['Latitude', currentMetadata.latitude],
    ['Longitude', currentMetadata.longitude],
    ['MD5', lastHashes.md5],
    ['SHA-1', lastHashes.sha1],
    ['SHA-256', lastHashes.sha256]
  ];
  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Metadata');
  XLSX.writeFile(wb, `${(currentFile.name || 'image').replace(/\.[^/.]+$/,'')}_metadata.xlsx`);
});

/* PDF generation: render a report div, snapshot with html2canvas, include image */
generatePdfBtn.addEventListener('click', async ()=>{
  if(!currentFile || !currentMetadata) return alert('Analyze a file first.');
  await createPdfReport();
});
quickGeneratePdf.addEventListener('click', async ()=> {
  if(!currentFile || !currentMetadata) return alert('Analyze a file first.');
  await createPdfReport();
});

async function createPdfReport(){
  // build report DOM
  const report = document.createElement('div');
  report.style.width = '1000px';
  report.style.padding = '20px';
  report.style.background = '#fff';
  report.style.color = '#000';
  report.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <h1 style="margin:0">META FORENSIC ‚Äî Forensic Report</h1>
        <div style="font-size:12px;margin-top:6px">Generated: ${new Date().toLocaleString()}</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:13px"><strong>Case:</strong> ${(currentCase && currentCase.id) || '(none)'}</div>
        <div style="font-size:13px"><strong>Evidence:</strong> ${(currentCase && currentCase.evidence) || '(none)'}</div>
      </div>
    </div>
    <hr style="margin:12px 0" />
    <div style="display:flex;gap:12px;">
      <div style="flex:1">
        <div style="font-weight:700">File</div>
        <div>File name: ${currentMetadata.fileName}</div>
        <div>Size: ${currentMetadata.fileSize}</div>
        <div>MIME: ${currentMetadata.mimeType}</div>
        <div style="margin-top:8px;font-weight:700">Camera</div>
        <div>Make: ${currentMetadata.make || '‚Äî'}</div>
        <div>Model: ${currentMetadata.model || '‚Äî'}</div>
        <div>Serial: ${currentMetadata.serial || '‚Äî'}</div>
      </div>
      <div style="width:320px">
        <div style="font-weight:700">Preview</div>
        <img src="${preview.src}" style="width:100%;border:1px solid #ddd;padding:6px;border-radius:6px;margin-top:6px" />
      </div>
    </div>

    <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      <div>
        <div style="font-weight:700">Timestamps</div>
        <div>Original: ${currentMetadata.dateOriginal || '‚Äî'}</div>
        <div>Modified: ${currentMetadata.dateModified || '‚Äî'}</div>
      </div>
      <div>
        <div style="font-weight:700">Hashes</div>
        <div>MD5: ${lastHashes.md5 || '‚Äî'}</div>
        <div>SHA-1: ${lastHashes.sha1 || '‚Äî'}</div>
        <div>SHA-256: ${lastHashes.sha256 || '‚Äî'}</div>
      </div>
    </div>

    <div style="margin-top:12px">
      <div style="font-weight:700">Chain of Custody</div>
      <div style="font-size:12px;margin-top:6px">
        ${(currentCase && currentCase.coc && currentCase.coc.length) ? currentCase.coc.map(e => `<div style="margin-bottom:6px"><strong>${new Date(e.time).toLocaleString()}</strong> ‚Äî ${e.actor} ‚Äî ${e.action} ${e.note?('<br/>' + e.note):''}</div>`).join('') : (cocEntries.length ? cocEntries.map(e => `<div style="margin-bottom:6px"><strong>${new Date(e.time).toLocaleString()}</strong> ‚Äî ${e.actor} ‚Äî ${e.action} ${e.note?('<br/>' + e.note):''}</div>`).join('') : '<div>(no CoC entries)</div>')}
      </div>
    </div>

    <div style="margin-top:12px;font-size:12px">
      <div style="font-weight:700">Notes</div>
      <div>${Array.isArray(computeManipulationNotes(currentMetadata._raw,lastHashes)) ? computeManipulationNotes(currentMetadata._raw,lastHashes).join(' | ') : computeManipulationNotes(currentMetadata._raw,lastHashes)}</div>
    </div>
  `;

  document.body.appendChild(report);
  // render
  const canvas = await html2canvas(report, { scale: 2, useCORS:true, allowTaint:true });
  const imgData = canvas.toDataURL('image/jpeg', 0.95);
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit:'px', format:[canvas.width, canvas.height] });
  pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height);
  // attach metadata JSON as an extra page
  pdf.addPage();
  const metaStr = JSON.stringify({ case: currentCase || null, metadata: currentMetadata, hashes: lastHashes, coc: currentCase ? currentCase.coc : cocEntries }, null, 2);
  const lines = pdf.splitTextToSize(metaStr, pdf.internal.pageSize.getWidth() - 40);
  pdf.setFontSize(10);
  pdf.text(lines, 20, 20);
  const fname = `forensic_report_${(currentCase && currentCase.id) || 'report'}.pdf`;
  pdf.save(fname);
  document.body.removeChild(report);

  // auto log in CoC
  addCocEntry((currentCase && currentCase.officer) || 'System', 'Report Generated', `PDF ${fname} created`);
}

/* ===== Copy metadata button ===== */
copyMetaBtn.addEventListener('click', ()=>{
  if(!currentMetadata) return alert('No metadata to copy.');
  navigator.clipboard.writeText(JSON.stringify({ metadata: currentMetadata, hashes: lastHashes }, null, 2));
  alert('Metadata JSON copied to clipboard');
});

/* ===== Misc helpers: detect editing apps and compute manip notes already above ===== */

/* ===== Boot: initial render COC and defaults ===== */
renderCoc();
hideMap();

/* Note: This web tool is for triage and demonstration. Hashes computed client-side for integrity checks; for court evidence follow your lab's validated processes. */

</script>
</body>
</html>
