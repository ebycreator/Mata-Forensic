<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Meta Forensic</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/exifreader/dist/exif-reader.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      background: url('https://images.unsplash.com/photo-1581091215364-37a5681d9c8b?auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed;
      background-size: cover;
    }
    .dropzone { transition: background-color .15s ease; }
    pre { max-height: 28rem; overflow: auto; }
    #map { height: 200px; border-radius: 0.5rem; margin-top: 0.5rem; }
    .card-header { background-color: rgba(30,64,175,0.1); padding: 0.5rem 1rem; border-radius: 0.5rem 0.5rem 0 0; font-weight: 600; }
    .card { background-color: rgba(255,255,255,0.9); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="text-slate-900 min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <header class="mb-6 text-center text-white">
      <h1 class="text-4xl font-bold">Meta Forensic</h1>
      <p class="text-lg mt-1">Upload a picture to view metadata</p>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Upload Section -->
      <section>
        <div id="drop" class="dropzone card text-center border-2 border-dashed border-slate-300">
          <input id="fileInput" type="file" accept="image/*" class="hidden" />
          <div id="dropInner">
            <p class="mb-2">Drag & drop an image here, or</p>
            <button id="chooseBtn" class="px-4 py-2 rounded bg-indigo-600 text-white">Choose file</button>
            <p class="mt-3 text-xs text-slate-500">Supports JPEG (EXIF), PNG (limited metadata), HEIC (browser dependent).</p>
          </div>
        </div>

        <div id="previewWrap" class="hidden card">
          <div class="flex gap-4 items-start">
            <img id="preview" alt="preview" class="w-48 h-48 object-contain rounded border" />
            <div class="flex-1">
              <div class="card-header">üì∑ General Info</div>
              <p id="basicInfo" class="text-sm text-slate-700 mt-2"></p>
              <div class="mt-3 flex gap-2">
                <button id="downloadMetaBtn" class="px-3 py-1 rounded border">Download JSON</button>
                <button id="copyMetaBtn" class="px-3 py-1 rounded border">Copy Metadata</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Metadata Section -->
      <aside>
        <div id="gpsWrap" class="hidden card">
          <div class="card-header">üåç GPS & Map</div>
          <p id="gpsText" class="text-sm text-slate-700 mt-2"></p>
          <a id="gpsLink" target="_blank" class="text-indigo-600 text-sm underline">Open in Google Maps</a>
          <div id="map"></div>
        </div>

        <div id="rawJsonWrap" class="hidden card">
          <div class="card-header">üóÇÔ∏è Metadata JSON</div>
          <pre id="rawJson" class="text-xs mt-2"></pre>
        </div>
      </aside>
    </main>
  </div>

  <script>
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('fileInput');
    const chooseBtn = document.getElementById('chooseBtn');
    const preview = document.getElementById('preview');
    const previewWrap = document.getElementById('previewWrap');
    const rawJson = document.getElementById('rawJson');
    const rawJsonWrap = document.getElementById('rawJsonWrap');
    const gpsWrap = document.getElementById('gpsWrap');
    const gpsText = document.getElementById('gpsText');
    const gpsLink = document.getElementById('gpsLink');
    const downloadMetaBtn = document.getElementById('downloadMetaBtn');
    const copyMetaBtn = document.getElementById('copyMetaBtn');
    const basicInfo = document.getElementById('basicInfo');

    let lastMetadata = null;
    let lastDataURL = null;
    let lastFileName = 'image';
    let map = null;
    let mapMarker = null;

    chooseBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    ['dragenter','dragover'].forEach(evt => drop.addEventListener(evt, (ev) => { ev.preventDefault(); drop.classList.add('bg-slate-50'); }));
    ['dragleave','drop'].forEach(evt => drop.addEventListener(evt, (ev) => { ev.preventDefault(); drop.classList.remove('bg-slate-50'); }));
    drop.addEventListener('drop', (ev) => { const f = ev.dataTransfer.files && ev.dataTransfer.files[0]; if (f) handleFiles([f]); });

    async function handleFiles(files) {
      if (!files || files.length === 0) return;
      const file = files[0];
      lastFileName = (file.name || 'image').replace(/\.[^/.]+$/, '');
      const arrayBuffer = await file.arrayBuffer();
      const dataURL = await readAsDataURL(file);
      lastDataURL = dataURL;

      preview.src = dataURL;
      previewWrap.classList.remove('hidden');

      let tags = {};
      try { tags = await ExifReader.load(arrayBuffer); } catch(e){ tags = {}; }
      lastMetadata = normalizeTags(tags);

      updateBasicInfo(file);
      renderFields(lastMetadata);

      rawJson.textContent = JSON.stringify(lastMetadata, null, 2);
      rawJsonWrap.classList.remove('hidden');
    }

    function readAsDataURL(file) {
      return new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onload = () => res(fr.result);
        fr.onerror = rej;
        fr.readAsDataURL(file);
      });
    }

    function normalizeTags(tags) {
      const out = {};
      for (const k in tags) {
        const t = tags[k];
        out[k] = (t && (t.description || t.value || t.format || t.tagType)) || t;
      }
      try {
        if(tags.GPSLatitude && tags.GPSLongitude){
          const lat = toDecimal(tags.GPSLatitude.value || tags.GPSLatitude);
          const lon = toDecimal(tags.GPSLongitude.value || tags.GPSLongitude);
          const latRef = (tags.GPSLatitudeRef && tags.GPSLatitudeRef.value) || '';
          const lonRef = (tags.GPSLongitudeRef && tags.GPSLongitudeRef.value) || '';
          out['_latitude'] = (latRef==='S')?-Math.abs(lat):lat;
          out['_longitude'] = (lonRef==='W')?-Math.abs(lon):lon;
        }
      } catch(e){}
      return out;
    }

    function toDecimal(input){
      if(!input) return null;
      if(typeof input==='number') return input;
      if(Array.isArray(input)){
        const [d,m,s]=input.map(Number);
        return d + (m||0)/60 + (s||0)/3600;
      }
      if(typeof input==='string'){
        const parts = input.split(',').map(p=>p.trim());
        const nums = parts.map(p=>{ const frac=p.split('/'); return frac.length===2?Number(frac[0])/Number(frac[1]):Number(p); });
        return nums[0] + (nums[1]||0)/60 + (nums[2]||0)/3600;
      }
      const n=Number(input); return isNaN(n)?null:n;
    }

    function updateBasicInfo(file){
      const sizeKB = (file.size/1024).toFixed(1);
      const modDate = new Date(file.lastModified).toLocaleString();
      basicInfo.textContent = `Type: ${file.type} ‚Ä¢ Size: ${sizeKB} KB ‚Ä¢ Modified: ${modDate}`;
    }

    function render
